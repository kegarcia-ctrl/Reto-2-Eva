<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inmobiliaria Kasa</title>
    <link rel="stylesheet" href="estilos/estiloweb.css">
</head>

<body>

    <div class="layout-grid">

        <header>
            <div class="logo-box">
                <img src="images/logoDefinitivo.png" alt="Logo">
            </div>

            <div class="header-right">
<!-- Bot√≥n Soy Propietario abre su propio modal -->
                <button class="btn-prop" onclick="window.location.href='#login-owner'">Soy Propietario</button>

                <button class="circle-btn flag-btn" onclick="toggleLangModal()">
                    <img src="images/ESflag.jpg" alt="ES">
                </button>

<!-- Bot√≥n Cuenta abre Login directamente -->
                <a href="#login" class="circle-btn" style="display:flex; align-items:center; justify-content:center;">
                    Cuenta
                </a>
            </div>
        </header>

        <aside class="sidebar-filtros">

            <div class="sidebar-header">
                <h3>Filtros</h3>
            </div>

            <div class="filtro-grupo">
                <label>Zona</label>
                <div class="input-wrapper">
                    <span class="icono-input">üìç</span>
                    <select id="filter-zona" onchange="applyFilters()">
                        <option value="todas">Todas</option>
                        <option value="centro">Centro</option>
                        <option value="norte">Norte</option>
                        <option value="sur">Sur</option>
                    </select>
                </div>
            </div>

            <div class="filtro-grupo">
                <label>Precio M√°x</label>
                <div class="input-wrapper">
                    <span class="icono-input">‚Ç¨</span>
                    <input type="number" id="filter-precio" placeholder="Ej: 1000" oninput="applyFilters()">
                </div>
            </div>

            <div class="filtro-grupo">
                <label>Tipo</label>
                <div class="input-wrapper">
                    <span class="icono-input">üè†</span>
                    <select id="filter-tipo" onchange="applyFilters()">
                        <option value="todos">Todos</option>
                        <option value="piso">Piso</option>
                        <option value="casa">Casa</option>
                        <option value="estudio">Estudio</option>
                    </select>
                </div>
            </div>

            <button class="btn-limpiar" onclick="clearFilters()">
                Limpiar Filtros
            </button>

        </aside>


<!--LOS PISOS Y CASAS-->
        <main> 
            <div class="property-card" data-zona="sur" data-precio="980" data-tipo="piso">
                <div class="marco-fotos">
                    <button class="btn-flotante izq" onclick="moverGaleria(event, this, -1)">‚ùÆ</button>
                    <div class="galeria">
                        <img src="images/piso21.png" alt="Cocina Moderna Nueva">
                        <img src="images/piso21.1.png" alt="Ba√±o Ducha Italiana">
                        <img src="images/piso21.2.png" alt="Habitaci√≥n Luminosa">
                    </div>
                    <button class="btn-flotante der" onclick="moverGaleria(event, this, 1)">‚ùØ</button>
                    <button class="btn-reservar" onclick="window.location.href='reserva.html'">
                         Reservar
                    </button>
                </div>
                <div class="card-info">
                    <div class="price">980‚Ç¨</div>
                    <div class="location">Reformado a estrenar</div>
                    <span class="ver-detalles" onclick="openModal(this.closest('.property-card'))">Ver detalles</span>
                    <div class="features">
                        <span>3 Hab</span><span>95m¬≤</span>
                    </div>
                </div>
            </div>
        </main>
    </div>

<!-- Footer -->
    <footer>
        <div class="footer-content">
            <div class="footer-column">
                <h3>Kasa</h3>
                <p>Calidad y confianza en tu b√∫squeda.</p>
            </div>
            <div class="footer-column">
                <h3>Navegaci√≥n</h3>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 5px;">
                    <a href="#">Inicio</a>
                    <a href="#">Alquileres</a>
                    <a href="#login-owner">Propietarios</a>
                    <a href="#login">Cuenta</a>
                </div>
            </div>
            <div class="footer-column">
                <h3>Contacto</h3>
                <p>üìß info@kasa.com | üìû +34 900 123 456</p>
                <div class="social-links">
                    <a href="#" class="social-icon">üì∑</a>
                    <a href="#" class="social-icon">üê¶</a>
                    <a href="#" class="social-icon">üìò</a>
                </div>
            </div>
        </div>
        <div class="footer-bottom">
            <p>&copy; 2026 Inmobiliaria Kasa.</p>
            <div style="display:flex; gap:10px;">
                 <a href="#">Legal</a>
                 <a href="#">Privacidad</a>
            </div>
        </div>
    </footer>

<!-- Modal de Propiedad -->
   <div id="propertyModal" class="modal-fondo">
        <div class="modal-contenido-grande">
            
            <div class="modal-col-izq">
                <button class="btn-flotante izq" onclick="moverGaleriaModal(-1)" style="left:15px; background:rgba(255,255,255,0.3); color:white; border:none;">‚ùÆ</button>
                
                <div id="modal-img-container" style="width:100%; height:100%; display:flex; overflow:hidden;">
                    </div>
                
                <button class="btn-flotante der" onclick="moverGaleriaModal(1)" style="right:15px; background:rgba(255,255,255,0.3); color:white; border:none;">‚ùØ</button>
            </div>

            <div class="modal-col-der">
                <span class="cerrar-modal-x" onclick="closeModal()">√ó</span>

                <h2 id="modal-title" style="color:#2c3e50; font-size:26px; margin-bottom:5px;">T√≠tulo</h2>
                <div id="modal-location" style="color:#777; margin-bottom:15px;">Ubicaci√≥n</div>
                
                <div id="modal-price" style="font-size:32px; font-weight:bold; color:#17a2b8; margin-bottom:20px;">0‚Ç¨</div>
                
                <div id="modal-features" class="features" style="border:none; padding:0; margin-bottom:10px;"></div>
                <div id="modal-services" style="display:flex; flex-wrap:wrap; gap:5px; margin-bottom:20px;"></div>
                
                <div style="flex:1; overflow-y:auto; margin-bottom:20px;">
                    <p id="modal-description-text" style="color:#555; line-height:1.6;">
                        Descripci√≥n de la propiedad...
                    </p>
                </div>

                <div style="display:flex; gap:10px;">
                    <button onclick="toggleCalendario()" style="flex:1; padding:12px; background:#2c3e50; color:white; border:none; border-radius:6px; cursor:pointer;">Ver Disponibilidad</button>
                    <button onclick="window.location.href='reserva.html?id=' + currentPropId" style="flex:1; padding:12px; background:#17a2b8; color:white; border:none; border-radius:6px; cursor:pointer;">Reservar</button>
                </div>

                <div id="calendario-reserva" class="calendario-reserva" style="display: none; text-align: center;">
                    <!-- Aqu√≠ se renderiza Flatpickr inline -->
                    <input type="text" id="flatpickr-inline" style="display:none;">
                </div>
            </div>
        </div>
    </div>

<!-- Modal de Idioma -->
    <div id="langModal" class="lang-modal-overlay" onclick="closeLangModal(event)">
        <div class="lang-modal-content">
            <div class="lang-modal-header">
                <h3>Selecciona tu idioma</h3>
                <button class="close-modal-btn" onclick="toggleLangModal()">√ó</button>
            </div>
            <div class="lang-list">
                <div class="lang-option active">
                    <img src="images/ESflag.jpg" class="lang-flag" alt="ES">
                    <span>Espa√±ol</span>
                    <span class="check-icon">‚úì</span>
                </div>
                <a href="webEN.html" class="lang-option">
                    <img src="images/UKflag.jpg" class="lang-flag" alt="UK">
                    <span>English (UK)</span>
                </a>
            </div>
        </div>
    </div>

<!-- Modal de Login -->
    <div id="login" class="modal-fondo">
        <div class="modal-login-content">
            <a href="#" class="cerrar">‚úï</a>
            <h2>Iniciar sesi√≥n</h2>
            <form onsubmit="realLogin(event, 'user')">
                <input type="email" name="email" placeholder="Correo" required>
                <input type="password" name="password" placeholder="Contrase√±a" required>
                <button type="submit">Entrar</button>
            </form>
            <p>¬øNo tienes cuenta? <a href="#registro">Crear cuenta</a></p>
        </div>
    </div>

<!-- Modal de Registro -->
    <div id="registro" class="modal-fondo">
        <div class="modal-login-content">
            <a href="#" class="cerrar">‚úï</a>
            <h2>Crear cuenta</h2>
            <form onsubmit="realRegister(event)">
                <input type="text" name="nombre" placeholder="Nombre" required>
                <input type="email" name="email" placeholder="Correo" required>
                <input type="password" name="password" placeholder="Contrase√±a" required>
                <button type="submit">Registrarse</button>
            </form>
            <p>¬øYa tienes cuenta? <a href="#login">Iniciar sesi√≥n</a></p>
        </div>
    </div>

<!-- Modal de Login Propietario -->
    <div id="login-owner" class="modal-fondo owner-modal">
        <div class="modal-login-content">
            <a href="#" class="cerrar">‚úï</a>
            <h2 style="color: #2c3e50;">Acceso Propietarios</h2>
            <form onsubmit="realLogin(event, 'owner')">
                <input type="email" name="email" placeholder="Correo Corporativo" required>
                <input type="password" name="password" placeholder="Contrase√±a" required>
                <button type="submit">Acceder</button>
            </form>
            <p>Solo personal autorizado.</p>
        </div>
    </div>

<!--SCRIPT-->

    <!-- Flatpickr CSS & JS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://npmcdn.com/flatpickr/dist/l10n/es.js"></script>

    <script>
        const API_BASE = 'http://localhost:8080/api';
        let currentPropId = null;
        let calendarInstance = null; // Instancia de Flatpickr

        document.addEventListener('DOMContentLoaded', () => {
            loadProperties();
            loadCitiesAndTypes();
        });

        async function loadCitiesAndTypes() {
            try {
                const [citiesResp, typesResp] = await Promise.all([
                    fetch(`${API_BASE}/lookup/cities`),
                    fetch(`${API_BASE}/lookup/types`)
                ]);
                const cities = await citiesResp.json();
                const types = await typesResp.json();

                const citySelect = document.getElementById('filter-zona');
                citySelect.innerHTML = '<option value="todas">Todas las zonas</option>';
                cities.forEach(c => {
                    citySelect.innerHTML += `<option value="${c.id}">${c.nombre}</option>`;
                });

                const typeSelect = document.getElementById('filter-tipo');
                typeSelect.innerHTML = '<option value="todos">Todos los tipos</option>';
                types.forEach(t => {
                    typeSelect.innerHTML += `<option value="${t.id}">${t.nombre}</option>`;
                });
            } catch (err) {
                console.warn("No se pudieron cargar los filtros desde la API.");
            }
        }

        async function loadProperties() {
            try {
                const response = await fetch(`${API_BASE}/properties`);
                if (!response.ok) throw new Error("Error en la API");
                const properties = await response.json();
                renderProperties(properties);
            } catch (err) {
                console.warn("Usando datos locales por falta de conexi√≥n al backend.");
            }
        }

        function renderProperties(properties) {
            const container = document.querySelector('main');
            if (properties.length === 0) {
                container.innerHTML = '<p style="grid-column: 1/-1; text-align:center; padding: 40px; color: #666;">No hay propiedades disponibles.</p>';
                return;
            }
            container.innerHTML = '';
            properties.forEach(p => {
                const div = document.createElement('div');
                div.className = 'property-card';
                div.dataset.zona = p.ciudadId;
                div.dataset.precio = p.precio;
                div.dataset.tipo = p.tipoPropiedadId;

                const imagenes = p.imagenes && p.imagenes.length > 0 
                    ? p.imagenes.map(img => `<img src="${img.urlImagen}" alt="${p.titulo}">`).join('')
                    : `<img src="images/piso21.png" alt="Propiedad">`;

                div.innerHTML = `
                    <div class="marco-fotos">
                        <button class="btn-flotante izq" onclick="moverGaleria(event, this, -1)">‚ùÆ</button>
                        <div class="galeria">${imagenes}</div>
                        <button class="btn-flotante der" onclick="moverGaleria(event, this, 1)">‚ùØ</button>
                        <button class="btn-reservar" onclick="window.location.href='reserva.html?id=${p.id}'">Reservar</button>
                    </div>
                    <div class="card-info">
                        <div class="price">${p.precio}‚Ç¨</div>
                        <div class="location">${p.titulo}</div>
                        <span class="ver-detalles" onclick='openModalById(${p.id})'>Ver detalles</span>
                        <div class="features">
                            <span>${p.habitaciones} Hab</span><span>${p.areaM2}m¬≤</span>
                        </div>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        async function openModalById(id) {
            currentPropId = id;
            try {
                const resp = await fetch(`${API_BASE}/properties/${id}`);
                const p = await resp.json();
                
                document.getElementById("modal-title").innerText = p.titulo;
                document.getElementById("modal-location").innerText = p.zona || p.titulo;
                document.getElementById("modal-price").innerText = p.precio + "‚Ç¨";
                document.getElementById("modal-features").innerHTML = 
                    `<span>${p.habitaciones} Hab</span><span>${p.areaM2}m¬≤</span>`;

                const sContainer = document.getElementById("modal-services");
                sContainer.innerHTML = '';
                if (p.servicios && p.servicios.length > 0) {
                    p.servicios.forEach(s => {
                        sContainer.innerHTML += `
                            <span style="background:#eee; padding:4px 8px; border-radius:4px; font-size:12px;">
                                ${s.nombre}
                            </span>
                        `;
                    });
                } else {
                    sContainer.innerHTML = '<span style="color:#999; font-size:12px;">Sin servicios extra</span>';
                }
                
                document.getElementById("modal-description-text").innerText = p.descripcion || "Sin descripci√≥n disponible.";

                const modalImgs = document.getElementById("modal-img-container");
                modalImgs.innerHTML = '';
                if (p.imagenes && p.imagenes.length > 0) {
                    p.imagenes.forEach(img => {
                        const el = document.createElement('img');
                        el.src = img.urlImagen;
                        el.style.minWidth = "100%";
                        modalImgs.appendChild(el);
                    });
                } else {
                    modalImgs.innerHTML = '<img src="images/piso21.png" style="minWidth: 100%">';
                }
                
                // Ocultamos calendario al abrir modal nuevo
                document.getElementById("calendario-reserva").style.display = "none";
                
                modal.style.display = "flex"; 
                document.body.style.overflow = "hidden";
            } catch (err) {
                console.error(err);
            }
        }

        async function realRegister(event) {
            event.preventDefault();
            const form = event.target;
            const data = {
                nombre: form.nombre.value,
                email: form.email.value,
                contrasena: form.password.value
            };

            try {
                const resp = await fetch(`${API_BASE}/users/register`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });
                const res = await resp.json();
                if (res.exito) {
                    alert('Cuenta creada exitosamente. Ya puedes entrar.');
                    window.location.hash = '#login';
                } else {
                    alert('Error: ' + res.mensaje);
                }
            } catch (err) {
                alert('No se pudo conectar con el servidor.');
            }
        }

        async function realLogin(event, type) {
            event.preventDefault();
            const form = event.target;
            const data = {
                email: form.email.value,
                contrasena: form.password.value
            };

            // First, try Admin specific check against the database
            if (type === 'owner') {
                try {
                    const adminResp = await fetch(`${API_BASE}/admins/login`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(data)
                    });
                    if (adminResp.ok) {
                        const adminRes = await adminResp.json();
                        localStorage.setItem('kasa_session', JSON.stringify({
                            type: 'admin',
                            data: adminRes.admin
                        }));
                        window.location.href = 'admin.html';
                        return;
                    }
                } catch (e) {
                    console.log("No es admin o error de red", e);
                }
            }

            const endpoint = type === 'user' ? '/users/login' : '/owners/login';
            const redirect = type === 'user' ? 'user.html' : 'propietario.html';

            try {
                const resp = await fetch(`${API_BASE}${endpoint}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });
                const res = await resp.json();
                if (res.exito) {
                    localStorage.setItem('kasa_session', JSON.stringify({
                        type: type,
                        data: res[type === 'user' ? 'usuario' : 'propietario']
                    }));
                    window.location.href = redirect;
                } else {
                    alert('Acceso denegado: ' + res.mensaje);
                }
            } catch (err) {
                alert('Error de conexi√≥n.');
            }
        }

        function toggleLangModal() {
            const modal = document.getElementById('langModal');
            modal.style.display = (modal.style.display === 'flex') ? 'none' : 'flex';
        }

        function closeLangModal(e) {
            if (e.target.id === 'langModal') {
                toggleLangModal();
            }
        }
        
        // 1. FILTROS
        function applyFilters() {
            const zona = document.getElementById('filter-zona').value;
            const precioMax = parseFloat(document.getElementById('filter-precio').value) || Infinity;
            const tipo = document.getElementById('filter-tipo').value;

            document.querySelectorAll('.property-card').forEach(card => {
                const cZona = card.getAttribute('data-zona') || "";
                const cPrecio = parseFloat(card.getAttribute('data-precio')) || 0;
                const cTipo = card.getAttribute('data-tipo') || "";

                let show = true;
                if (zona !== 'todas' && cZona != zona) show = false;
                if (cPrecio > precioMax) show = false;
                if (tipo !== 'todos' && cTipo != tipo) show = false;

                card.style.display = show ? 'flex' : 'none';
            });
        }

        function clearFilters() {
            document.getElementById('filter-zona').value = 'todas';
            document.getElementById('filter-precio').value = '';
            document.getElementById('filter-tipo').value = 'todos';
            applyFilters();
        }

        // 2. GALERIA DE LAS TARJETAS (Peque√±a)
        function moverGaleria(e, btn, dir) {
            e.stopPropagation(); // Evita que se abra el modal al hacer click en flechas
            const container = btn.parentElement.querySelector('.galeria');
            container.scrollBy({ left: dir * 300, behavior: 'smooth' });
        }

        // 3. LOGICA DEL MODAL DE DETALLES
        const modal = document.getElementById("propertyModal");
        
        function closeModal() {
            modal.style.display = "none";
            document.body.style.overflow = "auto";
        }
        
        // Cerrar si click fuera del contenido
        window.onclick = function(event) {
            if (event.target == modal) {
                closeModal();
            }
        }

        // Galer√≠a dentro del modal
        function moverGaleriaModal(dir) {
            const container = document.getElementById("modal-img-container");
            const w = container.offsetWidth;
            container.scrollBy({ left: dir * w, behavior: 'smooth' });
        }

        // 4. CALENDARIO REAL (Flatpickr)
        async function toggleCalendario() {
            const calDiv = document.getElementById("calendario-reserva");
            if (calDiv.style.display === "none") {
                calDiv.style.display = "block";
                
                // Cargar fechas ocupadas
                const bookedDates = await loadBookedDates(currentPropId);
                
                // Si ya existe instancia, destruirla para limpiar
                if (calendarInstance) calendarInstance.destroy();

                // Crear calendario inline (solo ver)
                calendarInstance = flatpickr("#flatpickr-inline", {
                    inline: true,
                    locale: 'es',
                    dateFormat: "Y-m-d",
                    minDate: "today",
                    disable: bookedDates,
                    // No queremos que seleccionen nada, solo ver
                    clickOpens: false 
                });
            } else {
                calDiv.style.display = "none";
            }
        }

        async function loadBookedDates(id) {
            try {
                const resp = await fetch(`${API_BASE}/bookings/property/${id}`);
                if (resp.ok) {
                    const bookings = await resp.json();
                    return bookings
                        .filter(b => b.status !== 'CANCELADA')
                        .map(b => ({
                            from: b.checkIn,
                            to: b.checkOut
                        }));
                }
                return [];
            } catch (e) {
                console.log("No se pudieron cargar reservas existentes.");
                return [];
            }
        }
    </script>
</body>

</html>